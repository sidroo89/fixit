# Phase 2: Firebase Integration, Authentication & RBAC

## ğŸ“‹ Overview

Phase 2 focuses on connecting the Flutter app to Firebase and implementing the complete authentication flow with Role-Based Access Control (RBAC). This document explains the implementation details with code references.

---

## ğŸ”¥ Firebase Connection Setup

### Step 1: Firebase Initialization

The app initializes Firebase in `main.dart` before running any widgets.

**File: `lib/main.dart`**

```dart:1:17:lib/main.dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';
import 'app/app.dart';

void main() async {
  // Ensure Flutter bindings are initialized
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // Run the app
  runApp(const FixItApp());
}
```

**Key Points:**
- **Line 7**: `WidgetsFlutterBinding.ensureInitialized()` is required before any async operations in `main()`
- **Lines 10-12**: Firebase is initialized with platform-specific options from `firebase_options.dart`
- **Line 15**: App runs only after Firebase is ready

### Step 2: Firebase Configuration

**File: `lib/firebase_options.dart`**

This file is auto-generated by FlutterFire CLI. It contains platform-specific Firebase credentials.

```dart:27:45:lib/firebase_options.dart
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      // ...
    }
  }
}
```

**To generate this file with your Firebase project:**

```bash
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure (run in project root)
flutterfire configure
```

---

## ğŸ” Role-Based Access Control (RBAC)

### How RBAC Works

1. **User registers** â†’ Gets default role `"user"` stored in Firestore
2. **User logs in** â†’ App fetches user document from Firestore
3. **App checks role** â†’ Routes to appropriate dashboard
4. **Admin promotion** â†’ Manual change in Firebase Console

### Database Structure for RBAC

**Firestore Collection: `users`**

```
users/
â””â”€â”€ {userId}/
    â”œâ”€â”€ email: "user@example.com"
    â”œâ”€â”€ name: "John Doe"
    â”œâ”€â”€ role: "user"          â† This field determines access
    â”œâ”€â”€ department: "IT"
    â”œâ”€â”€ photoUrl: "https://..."
    â””â”€â”€ createdAt: Timestamp
```

---

## ğŸ“¦ User Model Implementation

**File: `lib/data/models/user_model.dart`**

```dart:1:35:lib/data/models/user_model.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class UserModel {
  final String uid;
  final String email;
  final String name;
  final String role;
  final String? department;
  final String? photoUrl;
  final DateTime createdAt;

  UserModel({
    required this.uid,
    required this.email,
    required this.name,
    required this.role,
    this.department,
    this.photoUrl,
    required this.createdAt,
  });

  // Check if user is admin
  bool get isAdmin => role == 'admin';

  // Check if user is regular user
  bool get isUser => role == 'user';
```

**Key Points:**
- **Line 7**: The `role` field is the key to RBAC - it's a simple string (`"user"` or `"admin"`)
- **Lines 23-26**: Computed properties `isAdmin` and `isUser` for easy role checking

### Converting Firestore Document to Model

```dart:28:41:lib/data/models/user_model.dart
  // Factory constructor from Firestore document
  factory UserModel.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return UserModel(
      uid: doc.id,
      email: data['email'] ?? '',
      name: data['name'] ?? '',
      role: data['role'] ?? 'user',
      department: data['department'],
      photoUrl: data['photoUrl'],
      createdAt: (data['createdAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
    );
  }
```

**Line 35**: Default role is `'user'` if not specified - this ensures new users always start as regular users.

---

## ğŸ”‘ Authentication Service

**File: `lib/data/services/auth_service.dart`**

This service handles all Firebase Auth operations and user document management.

### Firebase Auth Instance

```dart:1:11:lib/data/services/auth_service.dart
import 'package:firebase_auth/firebase_auth.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../models/user_model.dart';

class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final GoogleSignIn _googleSignIn = GoogleSignIn();
```

**Lines 7-9**: Three Firebase services are initialized:
- `FirebaseAuth` - For authentication
- `FirebaseFirestore` - For storing user data and roles
- `GoogleSignIn` - For Google authentication

### Sign Up with Email (Creating User with Default Role)

```dart:29:56:lib/data/services/auth_service.dart
  // Sign up with email and password
  Future<UserCredential> signUpWithEmail({
    required String email,
    required String password,
    required String name,
    String? department,
  }) async {
    try {
      // Create user in Firebase Auth
      final credential = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      // Update display name
      await credential.user?.updateDisplayName(name);

      // Create user document in Firestore with 'user' role
      if (credential.user != null) {
        await createUserDocument(
          uid: credential.user!.uid,
          email: email,
          name: name,
          department: department,
        );
      }

      return credential;
    } on FirebaseAuthException {
      rethrow;
    }
  }
```

**Key Points:**
- **Lines 38-41**: First, create the user in Firebase Auth
- **Lines 47-52**: Then, create a Firestore document with the user's profile
- The `createUserDocument` method (shown below) sets the default role

### Creating User Document with Role

```dart:95:115:lib/data/services/auth_service.dart
  // Create user document in Firestore
  Future<void> createUserDocument({
    required String uid,
    required String email,
    required String name,
    String? department,
    String? photoUrl,
    String role = 'user', // Default role is 'user'
  }) async {
    final userModel = UserModel(
      uid: uid,
      email: email,
      name: name,
      role: role,
      department: department,
      photoUrl: photoUrl,
      createdAt: DateTime.now(),
    );

    await _firestore.collection('users').doc(uid).set(userModel.toMap());
  }
```

**Line 102**: `String role = 'user'` - This is the critical line that ensures all new users get the `"user"` role by default. This cannot be overridden by the client.

### Fetching User Role from Firestore

```dart:117:130:lib/data/services/auth_service.dart
  // Get user document from Firestore
  Future<UserModel?> getUserDocument(String uid) async {
    try {
      final doc = await _firestore.collection('users').doc(uid).get();
      if (doc.exists) {
        return UserModel.fromFirestore(doc);
      }
      return null;
    } catch (e) {
      return null;
    }
  }
```

This method is called after login to retrieve the user's profile including their role.

### Google Sign-In with Role Handling

```dart:58:93:lib/data/services/auth_service.dart
  // Sign in with Google
  Future<UserCredential?> signInWithGoogle() async {
    try {
      // Trigger the authentication flow
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();

      if (googleUser == null) {
        return null; // User cancelled the sign-in
      }

      // Obtain the auth details from the request
      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;

      // Create a new credential
      final credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      // Sign in to Firebase with the Google credential
      final userCredential = await _auth.signInWithCredential(credential);

      // Check if user document exists, if not create it
      if (userCredential.user != null) {
        final userDoc = await _firestore
            .collection('users')
            .doc(userCredential.user!.uid)
            .get();

        if (!userDoc.exists) {
          await createUserDocument(
            uid: userCredential.user!.uid,
            email: userCredential.user!.email ?? '',
            name: userCredential.user!.displayName ?? 'User',
            photoUrl: userCredential.user!.photoURL,
          );
        }
      }

      return userCredential;
    } catch (e) {
      rethrow;
    }
  }
```

**Lines 82-91**: For Google Sign-In, we check if a Firestore document exists:
- **If new user**: Create document with default `"user"` role
- **If existing user**: Use existing document (preserves admin role if set)

---

## ğŸ› Auth Provider (ViewModel)

**File: `lib/providers/auth_provider.dart`**

The AuthProvider manages authentication state and exposes role information to the UI.

### State Variables

```dart:1:24:lib/providers/auth_provider.dart
import 'package:flutter/foundation.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../data/models/user_model.dart';
import '../data/services/auth_service.dart';

enum AuthState {
  initial,
  loading,
  authenticated,
  unauthenticated,
  error,
}

class AuthProvider extends ChangeNotifier {
  final AuthService _authService = AuthService();

  AuthState _authState = AuthState.initial;
  User? _firebaseUser;
  UserModel? _currentUser;
  String? _errorMessage;
```

**Lines 6-12**: Auth states help the UI show appropriate loading/error states
**Line 19**: `_currentUser` contains the full user profile including role

### Role Checking Properties

```dart:23:30:lib/providers/auth_provider.dart
  // Getters
  AuthState get authState => _authState;
  User? get firebaseUser => _firebaseUser;
  UserModel? get currentUser => _currentUser;
  String? get errorMessage => _errorMessage;
  bool get isLoading => _authState == AuthState.loading;
  bool get isAuthenticated => _authState == AuthState.authenticated;
  bool get isAdmin => _currentUser?.role == 'admin';
  bool get isUser => _currentUser?.role == 'user';
```

**Lines 29-30**: `isAdmin` and `isUser` getters make role checking simple in the UI:

```dart
if (authProvider.isAdmin) {
  // Navigate to admin dashboard
} else {
  // Navigate to user home
}
```

### Initialization & Role Fetching

```dart:32:51:lib/providers/auth_provider.dart
  // Initialize and check auth state
  Future<void> initialize() async {
    _authState = AuthState.loading;
    notifyListeners();

    try {
      _firebaseUser = _authService.currentUser;

      if (_firebaseUser != null) {
        // User is logged in, fetch their document
        _currentUser = await _authService.getUserDocument(_firebaseUser!.uid);
        _authState = AuthState.authenticated;
      } else {
        _authState = AuthState.unauthenticated;
      }
    } catch (e) {
      _authState = AuthState.unauthenticated;
      _errorMessage = e.toString();
    }

    notifyListeners();
  }
```

**Lines 41-43**: When the app starts, if a user is logged in, we fetch their Firestore document to get their role. This determines which screen they see.

---

## ğŸš¦ The "Gatekeeper" - Role-Based Navigation

**File: `lib/presentation/screens/splash/splash_screen.dart`**

The splash screen acts as the "gatekeeper" that routes users based on their role.

### Auth Check & Routing Logic

```dart:45:75:lib/presentation/screens/splash/splash_screen.dart
  Future<void> _initializeApp() async {
    // Wait for animation and minimum splash time
    await Future.delayed(const Duration(seconds: 2));

    if (!mounted) return;

    // Initialize auth provider
    final authProvider = Provider.of<AuthProvider>(context, listen: false);
    await authProvider.initialize();

    if (!mounted) return;

    // Check if first time launch (show onboarding)
    final prefs = await SharedPreferences.getInstance();
    final hasSeenOnboarding = prefs.getBool('hasSeenOnboarding') ?? false;

    if (!mounted) return;

    // Navigate based on auth state
    if (authProvider.isAuthenticated) {
      // User is logged in, route based on role
      if (authProvider.isAdmin) {
        AppRoutes.navigateAndClearStack(context, AppRoutes.adminDashboard);
      } else {
        AppRoutes.navigateAndClearStack(context, AppRoutes.userHome);
      }
    } else {
      // User is not logged in
      if (hasSeenOnboarding) {
        AppRoutes.navigateAndClearStack(context, AppRoutes.login);
      } else {
        AppRoutes.navigateAndClearStack(context, AppRoutes.onboarding);
      }
    }
  }
```

**The Decision Flow:**

1. **Line 52**: Initialize AuthProvider (fetches user from Firebase)
2. **Line 64**: Check if user is authenticated
3. **Lines 66-70**: If authenticated, check role:
   - **Line 66-67**: `isAdmin` â†’ Admin Dashboard
   - **Line 68-69**: Not admin â†’ User Home
4. **Lines 72-77**: If not authenticated, show onboarding or login

### Visual Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SPLASH SCREEN                          â”‚
â”‚                                                          â”‚
â”‚  1. await authProvider.initialize()                      â”‚
â”‚     â””â”€â”€ Fetches user document from Firestore             â”‚
â”‚         â””â”€â”€ Gets role: "user" or "admin"                 â”‚
â”‚                                                          â”‚
â”‚  2. Check authProvider.isAuthenticated                   â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”œâ”€â”€ TRUE: Check authProvider.isAdmin                 â”‚
â”‚     â”‚   â”œâ”€â”€ TRUE â†’ Navigate to /admin-dashboard          â”‚
â”‚     â”‚   â””â”€â”€ FALSE â†’ Navigate to /user-home               â”‚
â”‚     â”‚                                                    â”‚
â”‚     â””â”€â”€ FALSE: Check hasSeenOnboarding                   â”‚
â”‚         â”œâ”€â”€ TRUE â†’ Navigate to /login                    â”‚
â”‚         â””â”€â”€ FALSE â†’ Navigate to /onboarding              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Login Screen - Post-Login Routing

**File: `lib/presentation/screens/auth/login_screen.dart`**

After successful login, users are routed based on their role.

### Email Login Handler

```dart:42:62:lib/presentation/screens/auth/login_screen.dart
  Future<void> _handleLogin() async {
    if (!_formKey.currentState!.validate()) return;

    final authProvider = Provider.of<AuthProvider>(context, listen: false);
    final success = await authProvider.signInWithEmail(
      _emailController.text.trim(),
      _passwordController.text,
    );

    if (!mounted) return;

    if (success) {
      // Navigate based on role
      if (authProvider.isAdmin) {
        AppRoutes.navigateAndClearStack(context, AppRoutes.adminDashboard);
      } else {
        AppRoutes.navigateAndClearStack(context, AppRoutes.userHome);
      }
    } else {
      // Show error
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(authProvider.errorMessage ?? AppStrings.errorLoginFailed),
          backgroundColor: AppColors.error,
        ),
      );
    }
  }
```

**Lines 54-58**: After login success, check role and navigate:
- Admin â†’ Admin Dashboard (Orange theme)
- User â†’ User Home (Teal theme)

### Google Sign-In Handler

```dart:64:84:lib/presentation/screens/auth/login_screen.dart
  Future<void> _handleGoogleSignIn() async {
    final authProvider = Provider.of<AuthProvider>(context, listen: false);
    final success = await authProvider.signInWithGoogle();

    if (!mounted) return;

    if (success) {
      // Navigate based on role
      if (authProvider.isAdmin) {
        AppRoutes.navigateAndClearStack(context, AppRoutes.adminDashboard);
      } else {
        AppRoutes.navigateAndClearStack(context, AppRoutes.userHome);
      }
    } else if (authProvider.errorMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(authProvider.errorMessage!),
          backgroundColor: AppColors.error,
        ),
      );
    }
  }
```

Same role-based routing applies to Google Sign-In.

---

## ğŸ‘¤ User Home Screen (Teal Theme)

**File: `lib/presentation/screens/user/user_home_screen.dart`**

```dart:14:30:lib/presentation/screens/user/user_home_screen.dart
  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);
    final user = authProvider.currentUser;

    return Scaffold(
      backgroundColor: AppColors.backgroundLight,
      appBar: AppBar(
        title: const Text(AppStrings.myRequests),
        backgroundColor: AppColors.primaryTeal,  // Teal for users
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Icons.logout),
            onPressed: () => _showLogoutDialog(context),
          ),
        ],
      ),
```

**Line 23**: Users see the **Teal** (`#009688`) colored AppBar, indicating they're in the user flow.

### Displaying Role

```dart:48:57:lib/presentation/screens/user/user_home_screen.dart
            // Role text - This is the demo placeholder showing "USER"
            Text(
              'USER',
              style: Theme.of(context).textTheme.displayMedium?.copyWith(
                    color: AppColors.primaryTeal,
                    fontWeight: FontWeight.bold,
                  ),
            ),
```

---

## ğŸ‘‘ Admin Dashboard Screen (Orange Theme)

**File: `lib/presentation/screens/admin/admin_dashboard_screen.dart`**

```dart:14:30:lib/presentation/screens/admin/admin_dashboard_screen.dart
  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);
    final user = authProvider.currentUser;

    return Scaffold(
      backgroundColor: AppColors.backgroundLight,
      appBar: AppBar(
        title: const Text(AppStrings.adminDashboard),
        backgroundColor: AppColors.accentOrange,  // Orange for admins
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Icons.settings),
            onPressed: () {
              // TODO: Navigate to settings
            },
          ),
```

**Line 23**: Admins see the **Orange** (`#FF5722`) colored AppBar, indicating they're in the admin flow.

### Displaying Role

```dart:65:74:lib/presentation/screens/admin/admin_dashboard_screen.dart
                  // Role text - This is the demo placeholder showing "ADMIN"
                  Text(
                    'ADMIN',
                    style: Theme.of(context).textTheme.displayMedium?.copyWith(
                          color: AppColors.accentOrange,
                          fontWeight: FontWeight.bold,
                        ),
                  ),
```

---

## ğŸ”§ How to Create an Admin User

Since the app doesn't allow self-registration as admin (for security), you must manually promote users:

### Method: Firebase Console

1. **Register normally** through the app (user gets `"user"` role)
2. Go to **Firebase Console** â†’ **Firestore Database**
3. Click on **users** collection
4. Find the user document (by email or UID)
5. Click on the document
6. Change `role` field from `"user"` to `"admin"`
7. Click **Update**

```
Before:                          After:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ email: "a@b.com"    â”‚         â”‚ email: "a@b.com"    â”‚
â”‚ name: "Admin User"  â”‚   â†’     â”‚ name: "Admin User"  â”‚
â”‚ role: "user"        â”‚         â”‚ role: "admin"       â”‚
â”‚ ...                 â”‚         â”‚ ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

8. User logs out and logs back in â†’ Now routes to Admin Dashboard!

---

## ğŸ”’ Firestore Security Rules for RBAC

To enforce RBAC at the database level:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can only read/write their own document
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId 
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      // Users cannot change their own role!
    }
    
    // Tickets collection
    match /tickets/{ticketId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && request.resource.data.createdByUid == request.auth.uid;
      
      // Only admins can update tickets
      allow update: if request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
```

**Key Security Rules:**
- Users **cannot** change their own role (Line 10-11)
- Only admins can update tickets (Line 19-20)
- The `role` check queries Firestore for the user's role document

---

## ğŸ“Š Summary: RBAC Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER REGISTRATION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. User clicks "Register"                                       â”‚
â”‚     â””â”€â”€ auth_service.dart: signUpWithEmail()                    â”‚
â”‚                                                                  â”‚
â”‚  2. Firebase Auth creates user                                   â”‚
â”‚     â””â”€â”€ Returns UserCredential with UID                         â”‚
â”‚                                                                  â”‚
â”‚  3. Create Firestore document                                    â”‚
â”‚     â””â”€â”€ auth_service.dart: createUserDocument()                 â”‚
â”‚         â””â”€â”€ role: 'user' (DEFAULT - cannot be overridden)       â”‚
â”‚                                                                  â”‚
â”‚  4. Navigate to User Home (Teal theme)                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER LOGIN                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. User enters credentials                                      â”‚
â”‚     â””â”€â”€ auth_provider.dart: signInWithEmail()                   â”‚
â”‚                                                                  â”‚
â”‚  2. Firebase Auth validates credentials                          â”‚
â”‚     â””â”€â”€ Returns UserCredential                                  â”‚
â”‚                                                                  â”‚
â”‚  3. Fetch user document from Firestore                          â”‚
â”‚     â””â”€â”€ auth_service.dart: getUserDocument()                    â”‚
â”‚         â””â”€â”€ Returns UserModel with role                         â”‚
â”‚                                                                  â”‚
â”‚  4. Check role and navigate                                      â”‚
â”‚     â””â”€â”€ login_screen.dart: _handleLogin()                       â”‚
â”‚         â”œâ”€â”€ role == 'admin' â†’ Admin Dashboard (Orange)          â”‚
â”‚         â””â”€â”€ role == 'user'  â†’ User Home (Teal)                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Phase 2 Checklist

| Task | Status | File Reference |
|------|--------|----------------|
| Firebase initialization | âœ… | `lib/main.dart` |
| Firebase options setup | âœ… | `lib/firebase_options.dart` |
| User model with role | âœ… | `lib/data/models/user_model.dart` |
| Auth service with RBAC | âœ… | `lib/data/services/auth_service.dart` |
| Auth provider | âœ… | `lib/providers/auth_provider.dart` |
| Splash screen with routing | âœ… | `lib/presentation/screens/splash/splash_screen.dart` |
| Onboarding carousel | âœ… | `lib/presentation/screens/onboarding/onboarding_screen.dart` |
| Login with role routing | âœ… | `lib/presentation/screens/auth/login_screen.dart` |
| Register with default role | âœ… | `lib/presentation/screens/auth/register_screen.dart` |
| User home (Teal theme) | âœ… | `lib/presentation/screens/user/user_home_screen.dart` |
| Admin dashboard (Orange theme) | âœ… | `lib/presentation/screens/admin/admin_dashboard_screen.dart` |

---

## ğŸš€ Next Steps

1. **Configure Firebase** by running `flutterfire configure`
2. **Enable Authentication** in Firebase Console
3. **Create Firestore Database**
4. **Test the flow**:
   - Register a user â†’ See "USER" screen
   - Change role to "admin" in Firestore
   - Login again â†’ See "ADMIN" screen

---

*Document Version: 1.0*
*Last Updated: December 2024*

